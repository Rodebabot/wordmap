import win32com.client
import pandas as pd
from datetime import datetime
from textblob import TextBlob

# === USER SETTINGS ===
start_date = datetime(2024, 8, 1)
end_date = datetime(2024, 8, 8)

# === Connect to Outlook ===
outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
inbox = outlook.GetDefaultFolder(6)  # 6 = Inbox

# === Function to recursively read mails from folder and subfolders ===
def read_mails(folder):
    mails = folder.Items
    mails.Sort("[ReceivedTime]", True)
    collected = []
    
    for mail in mails:
        try:
            received = mail.ReceivedTime
            if start_date <= received <= end_date:
                sender = mail.SenderName
                subject = mail.Subject
                body = mail.Body
                sentiment_score = TextBlob(body).sentiment.polarity
                sentiment = "Positive" if sentiment_score > 0 else "Negative" if sentiment_score < 0 else "Neutral"
                
                collected.append({
                    "Sender": sender,
                    "Received Time": received.strftime("%Y-%m-%d %H:%M:%S"),
                    "Subject": subject,
                    "Sentiment": sentiment,
                    "Preview": body[:100]
                })
        except:
            continue

    # Recurse into subfolders
    for subfolder in folder.Folders:
        collected += read_mails(subfolder)
    
    return collected

# === Read all mails ===
print("🔍 Reading emails...")
data = read_mails(inbox)

# === Save to Excel ===
df = pd.DataFrame(data)
output_file = f"Outlook_Emails_{start_date.strftime('%Y%m%d')}_{end_date.strftime('%Y%m%d')}.xlsx"
df.to_excel(output_file, index=False)
print(f"✅ Done! Saved to {output_file}")
